# Amazon EC2 のイロハとコスト最適化のキモ

AWS SUMMIT TOKYO(2023/04/20)での表題のセッションにおける備忘録となります

## Amazon EC2 の概要

https://aws.amazon.com/jp/ec2/

## イ: インスタンス選択方法は？

### インスタンスの選択肢

|  カテゴリー  |  機能  |
| ---- | ---- |
|  汎用  |  CPU  |
|  コンピューティング最適化  |  高周波数  |
|  メモリ最適化  |  高いメモリフットプリント  |
|  高速コンピューティング  |  インスタンスストレージ  |
|  ストレージ最適化  |  高速ネットワーク  |
|  HPC 最適化  |  サイズ  |
|    |  ベアメタル  |

### プロセッサ

* x86_64
  * Intel Xeon Scalable processors
  * AMD EPYC processors
* arm64
  * AWS Graviton processors
  * Apple M1 processors

### Amazon EC2 C6in, M6in, M6idn, R6in, R6idn インスタンス

* 第 3 世代 Intel Xeon Scalable プロセッサ搭載
* 最大 200 Gbps のネットワーク帯域幅
* ネットワーク仮想アプライアンスやリアルタイムビッグデータ分析、インメモリデータベースなどネットワーク帯域を活かしたワークロードに理想的

### Amazon EC2 C7g

* AWS Graviton3 プロセッサ搭載インスタンス
* クラウドで最初に一般提供したDDR5 メモリ搭載インスタンス（高速, 低消費電力）
* 同等の x86 系 EC2 インスタンスと比較し、同じ処理に使用するエネルギーが最大 60% 削減
* バッチ処理や HPC、電子設計自動化 (EDA)、ビデオエンコーディング、科学的モデリングなどに理想的

## ロ: 配置は？

### シングル AZ

EC2 インスタンスを任意のアベイラビリティーゾーン（AZ）に配置

### マルチ AZ

EC2 インスタンスを複数のアベイラビリティーゾーン（AZ）に分散して配置することで可用性を向上

### マルチリージョン

EC2 インスタンスを別リージョンに配置しリージョンが利用できない場合もシステムにアクセスできるように配置可能

### 可用性に関する検討ポイント

* 業務システムに求められる RTO / RPO および可用性目標
* コスト（マルチ AZ << マルチリージョン）

## ハ: 何台必要？

* Amazon EC2 Auto Scaling を利用して EC2 インスタンス数を維持
  * 突発的な負荷が発生する可能性（マーケティング活動によるアクセス集中など）

* Auto Scaling グループをマルチ AZ 構成にすることで耐障害性向上


## コスト最適化

### こんな場合に

* 見積当初のインスタンスサイズが大きすぎた
  * インスタンスの見直し
* 夜間帯はほとんど使われずアイドル時間が長かった
  * 未使用リソース停止
  * スケジューリング
* 見積当初のディスクサイズが大きすぎた
  * ストレージの見直し

### 例

* インスタンスタイプの変更(サイズ)

|  m5.4xlarge  |  m5.xlarge  |
| ---- | ---- |
|  0.992 USD / 時  |  0.248 USD / 時  |

* インスタンスタイプの変更(世代変更)

|  m3.xlarge  |  m6i.xlarge  |
| ---- | ---- |
|  0.385 USD / 時  |  0.248 USD / 時  |

* インスタンスタイプの変更(CPU)

|  m5.xlarge  |  m5a.xlarge  |
| ---- | ---- |
|  0.248 USD / 時  |  0.224 USD / 時  |

### AWS Graviton

同等の x86 系インスタンスと比較して

* 約 40% コストパフォーマンス向上
* 最大 60％ 消費電力削減

1 vCPU あたりの性能が20%～40% 向上

### どれを最適化？

AWS Cost Explorer が EC2 インスタンスの使用状況を分析し コスト最適化の方法を提案。AWS Cost Explorer の設定でチェックボックスを有効にするだけの簡単設定で確認できる。